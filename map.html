<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<link rel="stylesheet"
		href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.9.0/css/ol.css" type="text/css">
	<style>
		.map {
			height: 700px;
			width: 100%;
		}
	</style>
	<script type="text/javascript" src="orders_js.json"></script>
	<script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.9.0/build/ol.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.5/proj4.js"
		integrity="sha512-MMmVaQGDVI3Wouc5zT5G7k/snN9gPqquIhZsHgIIHVDlRgYTYGxrwu6w482iIhAq8n5R6+pcBgpGgxFFBz7rZA=="
		crossorigin="anonymous" referrerpolicy="no-referrer"></script>

	<link rel="stylesheet" href="css/map.css">

	<title>OpenLayers example</title>
</head>

<body>
	<div id="map" class="map">
		<button onclick="polygonStatsPressed()">Статистика по области</button>
		<button onclick="removePolygonStats()">Отмена</button>
	</div>
	<script type="text/javascript">
		function point_to_wgs84(inp_point) {
			cord_i = inp_point.substring(1, inp_point.length - 1).split(',')
			cord = ol.proj.fromLonLat([cord_i[1], cord_i[0]])
			return cord
		}

		const polygonSource = new ol.source.Vector({ wrapX: false });
		const heatmapSource = new ol.source.Vector({})

		let hasSelection = false
		let draw
		function polygonStatsPressed() {
			if (hasSelection) return
			draw = new ol.interaction.Draw({
				source: polygonSource,
				type: "Polygon",
			});
			map.addInteraction(draw);
			draw.on("drawend", _ => {
				hasSelection = true
				map.removeInteraction(draw)
			})
		}
		function removePolygonStats() {
			hasSelection = false
			polygonSource.clear()
		}

		var map = new ol.Map({
			// controls: ol.control.defaults().extend([panel]),
			target: "map",
			layers: [
				new ol.layer.Tile({
					source: new ol.source.OSM(),
				}),
				new ol.layer.Heatmap({
					source: heatmapSource,
					gradient: ["#05BC58", "#B1DF03", "#FFFE01", "#FF3104", "#9A2504"],
					opacity: 0.9,
					radius: 10,
					blur: 5
				}),
				new ol.layer.Vector({
					source: polygonSource
				})
			],
			view: new ol.View({
				center: ol.proj.fromLonLat([39.954962, 57.651345]),
				zoom: 11,
			})
		});

		function changeCity(cityPoint) {
			console.log(map)
			view = map.getView()
			view.setCenter(point_to_wgs84(cityPoint))
			view.setZoom(11)
		}

		function setData(orders_data) {
			features = []
			orders_data.forEach(inp_point => {

				features.push(new ol.Feature({
					geometry: new ol.geom.Point(point_to_wgs84(inp_point.point)),
					weight: 0.1
				}))
			})

			heatmapSource.clear()
			heatmapSource.addFeatures(features)
		}

		raw_orders = JSON.parse(input_orders)
		setData(raw_orders)

		// changeCity("[59.223991, 39.887175]")
	</script>
</body>

</html>