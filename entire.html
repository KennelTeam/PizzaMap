<!doctype html>
<html lang="ru">
  <head>
    <!-- Обязательные метатеги -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet"
		href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.9.0/css/ol.css" type="text/css">
	<style>
		.map {
			height: 500px;
			width: 100%;
		}
	</style>
	<script type="text/javascript" src="orders_js.json"></script>
	<script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.9.0/build/ol.js"></script>
	

    <!-- Bootstrap CSS -->

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">

    <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    
    <link rel="stylesheet" href="css/filters.css">
    <link rel="stylesheet" href="css/legend.css">

    <title>Прога тупа</title>
  </head>
  <body>
    <div class="container">
        <div class="row">
            <div class="fiters-container col-2">
                <div class="form-group">
                    <label class="town-choose-label label" for="townChoose">Город</label>
                    <select class="select-list form-select" id="townChoose" aria-label="Floating label select example">
                        <option class="list-item" selected>
                            <div>Вологда</div>
                        </option>
                        <option class="list-item">
                            <div>Москва</div>
                        </option>
                        <option class="list-item">
                            <div>Санкт-Перербург</div>
                        </option>
                        <option class="list-item">
                            <div>Ярославль</div>
                        </option>
                    </select>
                </div>
                <label class="order-type-label label" for="orderTypeChoose">Вид заказов</label>
                <select class="select-list form-select" id="orderTypeChoose" aria-label="Floating label select example">
                    <option class="list-item" selected value="all">Все заказы</option>
                    <option class="list-item" value="new">Новые</option>
                    <option class="list-item" value="canceled">Отменённые</option>
                </select>
                <div class="late-order form-check">
                    <input class="late-orders-checkbox form-check-input" type="checkbox" value="" id="showLateOrders">
                    <label class="late-orders-label form-check-label" for="showLateOrders">Опоздавшие заказы</label>
                </div>
                <label class="order-sum-label label" for="orderSum">Сумма заказа</label>
                <select class="select-list form-select" id="orderSum" aria-label="Floating label select example">
                    <option class="list-item" selected value="0">На любую сумму</option>
                    <option class="list-item" value="500">от 500 руб.</option>
                    <option class="list-item" value="1000">от 1000 руб.</option>
                    <option class="list-item" value="5000">от 5000 руб.</option>
                </select>
                <label class="promo-input-label label" for="promoInput">Поиск по промокоду</label>
                <input class="promo-input form-control" type="text" id="promoInput"/>
                <label class="period-label label">Период</label>
                <input class="date-filter form-control" type="text" name="datefilter" value="01.11.2021 - 30.11.2021" />

                <script type="text/javascript">
                    $(function() {

                        $('input[name="datefilter"]').daterangepicker({
                            autoUpdateInput: false,
                            locale: {
                                cancelLabel: 'Clear'
                            }
                        });

                        $('input[name="datefilter"]').on('apply.daterangepicker', function(ev, picker) {
                            $(this).val(picker.startDate.format('DD.MM.YYYY') + ' - ' + picker.endDate.format('DD.MM.YYYY'));
                        });

                        $('input[name="datefilter"]').on('cancel.daterangepicker', function(ev, picker) {
                            $(this).val('');
                        });

                    });
                </script>

                <div class="form-group row">
                    <div class="col-sm">
                        <button class="reset-filter-button btn" id="clearButton">Сбросить фильтр</button>
                    </div>
                </div>
                <div class="form-group row">
                    <div class="col-sm">
                        <button type="submit" class="show-button btn" id="showButton">Показать</button>
                    </div>
                </div>
                <script src="dicts.json"></script>
                <script src="orders_js.json"></script>
                <script src="filters.js"></script>

            </div>
            <div class="col-9">
                <div id="map" class="map">
                    <button onclick="polygonStatsPressed()">Статистика по области</button>
                    <button onclick="removePolygonStats()">Отмена</button>
                </div>
            </div>
            <div class="legend container" style="margin-top: 40px;">
                <div class="row">
                    <div class="progress-bar-block col-sm">
                        <div class="progress-bar row"></div>
                        <div class="progress-bar-values row">
    
                            <div class="value-1 progress-bar-value col">0</div>
                            <div class="value-2 progress-bar-value col">644</div>
                            <div class="value-3 progress-bar-value col">1289</div>
                            <div class="value-4 progress-bar-value col">1933</div>
                            <div class="value-5 progress-bar-value col">2578</div>
    
                        </div>
                    </div>
                    <div class="number-of-orders col-sm">
                        <div class="number-of-orders-label label col">Количество заказов</div>
                        <div class="number-of-orders-value value col">0</div>
                    </div>
                    <div class="number-of-delay col-sm">
                        <div class="number-of-delay-label label col">Количество опозданий</div>
                        <div class="number-of-delay-value value col">0</div>
                    </div>
                    <div class="mean-delivery-time col-sm">
                        <div class="mean-delivery-time-label label col">Ср. время доставки</div>
                        <div class="mean-delivery-time-value value col">0</div>
                    </div>
                    <div class="revenue col-sm">
                        <div class="revenue-label label col">Выручка</div>
                        <div class="revenue-value value col">0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous"></script>
    <script type="text/javascript" src="dicts.json"></script>
    <!-- <script type="text/javascript" src="filters.js"></script> -->
    <script type="text/javascript">
		function point_to_wgs84(inp_point) {
			cord_i = inp_point.substring(1, inp_point.length - 1).split(',')
			cord = ol.proj.fromLonLat([cord_i[1], cord_i[0]])
			return cord
		}

		const polygonSource = new ol.source.Vector({ wrapX: false });
		const heatmapSource = new ol.source.Vector({})

		let hasSelection = false
		let draw
		function polygonStatsPressed() {
			if (hasSelection) return
			draw = new ol.interaction.Draw({
				source: polygonSource,
				type: "Polygon",
			});
			map.addInteraction(draw);
			draw.on("drawend", _ => {
				hasSelection = true
				map.removeInteraction(draw)
			})
		}
		function removePolygonStats() {
			hasSelection = false
			polygonSource.clear()
		}

		var map = new ol.Map({
			// controls: ol.control.defaults().extend([panel]),
			target: "map",
			layers: [
				new ol.layer.Tile({
					source: new ol.source.OSM(),
				}),
				new ol.layer.Heatmap({
					source: heatmapSource,
					gradient: ["#05BC58", "#B1DF03", "#FFFE01", "#FF3104", "#9A2504"],
					opacity: 0.9,
					radius: 10,
					blur: 5
				}),
				new ol.layer.Vector({
					source: polygonSource
				})
			],
			view: new ol.View({
				center: ol.proj.fromLonLat([39.954962, 57.651345]),
				zoom: 11,
			})
		});

		function changeCity(cityPoint) {
			console.log(map)
			view = map.getView()
			view.setCenter(point_to_wgs84(cityPoint))
			view.setZoom(11)
		}

		function setData(orders_data) {
			features = []
			orders_data.forEach(inp_point => {

				features.push(new ol.Feature({
					geometry: new ol.geom.Point(point_to_wgs84(inp_point.point)),
					weight: 0.1
				}))
			})

			heatmapSource.clear()
			heatmapSource.addFeatures(features)
		}

		raw_orders = JSON.parse(input_orders)
		setData(raw_orders)

		// changeCity("[59.223991, 39.887175]")
	</script>
  </body>
</html>